(()=>{var d=function(...n){console.log("WSocket",...n)},w=function(...n){console.error("WSocket",...n)},D=1,b=class b{constructor(e,t){this.url="";this.ws=null;this._callback=null;this.opts={retry:1,interval:1e3,cacert:""};this._reconnectTimer=null;this.url=e,this.opts=t,this.connect(e)}destroy(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._callback=null,this.close()}connect(e){if(e&&(this.url=e),this.ws){let o=this.ws;this.ws=null,o.close()}d(`connect ${this.url}`);let t=b.class,i=null;this.opts.cacert?(i=new t(this.url,[],this.opts.cacert),d("cacert",this.opts.cacert)):i=new t(this.url),i.binaryType="arraybuffer",i.onopen=o=>{this.onopen(i,o)},i.onmessage=o=>{this.onmessage(i,o)},i.onclose=o=>{this.onclose(i,o)},i.onerror=o=>{this.onerror(i,o)},i.uuid=D++,this.ws=i}_reconnect(){this.opts.retry>0&&(this.opts.retry--,this._reconnectTimer=setTimeout(()=>{clearTimeout(this._reconnectTimer),this._reconnectTimer=null,this.connect(this.url)},this.opts.interval))}send(e){this.ws&&this.ws.send(e)}close(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null);let e=this.ws;this.ws=null,e&&e.close()}on(e){this._callback=e}onopen(e,t){d(`${this.url} onopen ${e.uuid} `),this.ws&&e.uuid===this.ws.uuid&&(this.opts.retry=0,this._callback("onopen",t))}onerror(e,t){if(w(` ${this.url} onerror`,t),this.ws&&e.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._callback("onerror",t)}}onclose(e,t){if(d(`${this.url} onclose   `,t),this.ws&&e.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._callback("onclose",t)}}onmessage(e,t){this.ws&&e.uuid===this.ws.uuid&&this._callback("onmessage",t.data)}};b.class=WebSocket;var _=b;var E=typeof GameGlobal!="undefined"?GameGlobal:typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:Object.create(null),c={CALL_ERROR:1e5,CONNECTING_REPEAT_ERROR:100001,CONNECT_TIMEOUT:100002,PROTOCOL_TIMEOUT:100003,HEARTBEAT_TIMEOUT:100004,HEARTBEAT_FAILED:100005,CONNECTING_NOW:100006,PROTO_PARSE_ERROR:2e5,CSV_ERROR:200001,CSV_NO_RESPONSE:200002,CMDMERGE_NOT_FOUND:200003,MESSAGE_NOT_FOUND:200004,NO_HANDLER:200005,ENCODE_FAILED:200010,DECODE_FAILED:200011};var I=function(...n){console.log("WSocketProtoBuf",...n)},f=function(...n){console.error("WSocketProtoBuf",...n)};function k(n,e){if(n!=null){if(Array.isArray(n))for(let t=0;t<n.length;t++)e.isLong(n[t])?n[t]=n[t].toNumber():typeof n[t]=="object"&&n[t]!==null&&k(n[t],e);else if(typeof n=="object")for(let t of Object.keys(n))e.isLong(n[t])?n[t]=n[t].toNumber():typeof n[t]=="object"&&n[t]!==null&&k(n[t],e)}}function O(n){return n==="PingReq"||n==="PingResp"}var T=class{constructor(e){this.protobuf=null;this.protoPackage="";this.Builder=null;this.encryptUtils=null;this.proto_define=null;this.proto_configs=null;this.protobuf=e,this.Builder=new this.protobuf.Builder}setConfig(e,t){this.protoPackage=t.proto_define.package,this.proto_define=t.proto_define,this.proto_configs=t.proto_configs;let i=this.protobuf.loadJson(this.proto_define,this.Builder,e),o=this.Builder.build();this.Builder.build(this.protoPackage)||I(` - Error: ${c.PROTO_PARSE_ERROR} protoName: ${e} protoPackage: ${this.protoPackage}`)}getProtoConfig(e){return this.proto_configs.get(e)}getCMDMerge(e){for(let[t,i]of this.proto_configs.entries())if(i[1]===e)return t;return 0}encodeObjectToMessage(e,t){try{let i=this.Builder.build(this.protoPackage);if(!i)throw new Error(`${this.protoPackage} builder build failed`);let o=i[e];return o?new o(t):(f(` - Error: ${c.DECODE_FAILED} msgName: ${e}`),null)}catch(i){f(` - Error: ${c.ENCODE_FAILED} error: ${i.toString()}`)}return null}encodeRequest(e,t,i){try{let r=this.Builder.build(this.protoPackage).ExternalMessage;r||f(` - Error: ${c.MESSAGE_NOT_FOUND} protoPackage: ${this.protoPackage}`);let l=O(e)?0:1,C=this.getCMDMerge(e);C===0&&!O(e)&&f(` - Error: ${c.CMDMERGE_NOT_FOUND} msgName: ${e}`);let p=this.encodeObjectToMessage(e,i);p||f(` - Error: ${c.ENCODE_FAILED} msgName: ${e}`);let g={cmdCode:l,protocolSwitch:0,cmdMerge:C,responseStatus:0,validMsg:"",data:p.encode().toBuffer(),seqId:t},h=new r(g).encode().toBuffer();return this.encryptUtils&&(h.byteLength>0||h.length>0)?this.encryptUtils.AESEncData(h):h}catch(o){throw f(` - Error: ${c.ENCODE_FAILED} msgName: ${o.toString()}`),o}}decodeResponse(e,t=!0){try{return t&&e.byteLength>0&&this.encryptUtils&&(e=this.encryptUtils.AESDecData(e)),this.decodeData("ExternalMessage",e)}catch(i){return f(` - Error: ${c.DECODE_FAILED} error: ${i.toString()}`,i),null}}decodeData(e,t){try{let i=this.Builder.build(this.protoPackage);if(!i)throw new Error(`${this.protoPackage} builder build failed`);let o=i[e];o||f(` - Error: ${c.DECODE_FAILED} msgName: ${e}`);let r=o.decode(t);return k(r,this.protobuf.Long),r}catch(i){return f(` - Error: ${c.DECODE_FAILED} error: ${i.toString()}`,i),null}}};var a=function(...n){console.log("WSocketClient",...n)};function u(n){return function(...e){console.log(n,...arguments)}}var y=["","PingReq","PingResp"],s=class s{constructor(){this.config={debugMode:!1,WebSocket,connectRetry:3,connectInterval:3e3,connectTimeout:1e4,protocolTimeout:1e4,heartbeatTimeout:15e3,heartbeatInterval:5e3,tickInterval:1e3,autoReconnect:!0,cacert:"",onStateChange:u("onStateChange"),onConnectTimeout:u("onConnectTimeout"),onAutoReconnectStart:u("onAutoReconnectStart"),onAutoReconnectEnd:u("onAutoReconnectEnd"),onProtocolTimeout:u("onProtocolTimeout"),onHeartbeatTimeout:u("onHeartbeatTimeout"),onHeartbeat:u("onHeartbeat"),onOpen:u("onOpen"),onClose:u("onClose"),onError:u("onError"),onMessage:function(e){}};this.protobufUtil=null;this._wsocket=null;this._listeners=new Map;this._on_listeners=new Map;this._connectCallback=null;this._ticker=null;this._state=s.NONE;this._ping=0;this._lastHeartbeatTime=0;this._lastHeartbeatResponseTime=0;this._connectTime=0;this._seqid=1;this._isProtoLoaded=!1;this._isInReconnect=!1}static getInstance(){return s._instance||(a("v",s.VERSION),s.protobuf=E.protobuf,s._instance=new s),s._instance}get wsocket(){return this._wsocket}get url(){return this._wsocket?this._wsocket.url:""}get isConnected(){return this._state===s.CONNECTTED}get isReconnecting(){return this._isInReconnect}_invokeConnect(e){let t=this._connectCallback;this._connectCallback=null,t&&t(e,this)}get state(){return this._state}setState(e){if(this._state===e)return;let t={from:this._state,to:e};switch(this._state=e,e){case s.DISCONNECTED:{this._listeners.clear(),this._stopTicker(),this._invokeConnect(!1);break}case s.CONNECTING:{this._connectTime=Date.now(),this._startTicker();break}case s.CONNECTTED:{this._seqid=1,this._isInReconnect=!1,this._invokeConnect(!0),this._lastHeartbeatResponseTime=Date.now(),this._sendHeartbeat();break}}this.config.debugMode&&a(`State: ${JSON.stringify(t)}`),this.config.onStateChange&&this.config.onStateChange(t)}get ping(){return this._ping}get serverTime(){return Date.now()+this._ping}reset(){this.close(),this._listeners.clear(),this._on_listeners.clear(),this._stopTicker(),this._connectCallback=null,this._wsocket=null,this._state=s.NONE,this._lastHeartbeatTime=0,this._connectTime=0,this._isProtoLoaded=!1,this.protobufUtil=null}setProtoConfig(e){this.protobufUtil=new T(s.protobuf),this.protobufUtil.setConfig(e.protoName,e),this._isProtoLoaded=!0}connect(e,t){if(!this._isProtoLoaded)return a(`Error: ${c.CALL_ERROR}`),t&&t(!1,this);if(this._state==s.CONNECTTED)return t&&t(!0,this);if(this._state==s.CONNECTING)return a(`Error: ${c.CONNECTING_REPEAT_ERROR}`),t&&t(!1,this);this._connectCallback=t,this.setState(s.CONNECTING),this._wsocket?(this._wsocket.opts.interval=this.config.connectInterval,this._wsocket.opts.retry=this.config.connectRetry,this._wsocket.opts.cacert=this.config.cacert,this._wsocket.connect(e)):(this._wsocket=new _(e,{retry:this.config.connectRetry,interval:this.config.connectInterval,cacert:this.config.cacert}),this._wsocket.on(this._wsHandler.bind(this)))}close(e=-1){this._wsocket&&this._wsocket.close(),this._connectCallback=null,this._listeners.clear(),this._stopTicker(),this.setState(s.DISCONNECTED)}send(e,t,i){switch(this._state){case s.CONNECTTED:{let o=this._seqid++,r=this.protobufUtil.encodeRequest(e,o,t);if(r){this.config.debugMode&&a("send : ",e,o),this._wsocket.send(r);let l={seqId:o,time:Date.now(),msgName:e,timeout:!1,callback:i};return this._listeners.set(o,l),l}}case s.CONNECTING:{a(`Error: ${c.CONNECTING_NOW}`);break}default:}return i(null,null),null}onNTF(e,t,i=0){let o=this._on_listeners.get(e);o?(o.push({priority:i,callback:t}),o.sort((r,l)=>l.priority-r.priority)):this._on_listeners.set(e,[{priority:i,callback:t}])}offNTF(e,t){let i=this._on_listeners.get(e);if(i)if(t&&typeof t=="function")for(let o=0;o<i.length;o++)i[o].callback===t&&(i.splice(o,1),i.length===0&&this._on_listeners.delete(e));else i.length=0,this._on_listeners.delete(e)}_data(e){let t=this.protobufUtil.decodeResponse(e);if(t){this.config.onMessage&&this.config.onMessage(t);let i=null;if(t.cmdCode===0)i=y;else{let h=t.cmdMerge;i=this.protobufUtil.getProtoConfig(h),i||a(` -Error: ${c.CSV_ERROR}, cmdMerge: ${h}`)}let o=i[1],r=i[2],l=t.seqId;if(this.config.debugMode&&a("receive : ",r,l),r||a(` - Error: ${c.CSV_NO_RESPONSE} ${r} - ${l}`),!(this._listeners.has(l)||this._on_listeners.has(r))){this.config.debugMode&&a(`${c.NO_HANDLER} ${r} - ${l}`);return}let p={code:t.responseStatus,data:this.protobufUtil.decodeData(r,t.data),msgName:r},g=this._listeners.get(l);g&&(this._listeners.delete(l),g.callback(o,p),g.callback=null);let N=this._on_listeners.get(r);if(N){let h=N.slice();for(let R of h)R.callback(r,p)}}}_wsHandler(e,t){switch(e){case"onmessage":{this._data(t);break}case"onclose":let i=this._state;this.close(),i===s.CONNECTTED&&this.config.autoReconnect&&!this._isInReconnect?(this._isInReconnect=!0,this.config.onAutoReconnectStart&&this.config.onAutoReconnectStart(),this.connect(this.url,(o,r)=>{this._isInReconnect=!1,this.config.onAutoReconnectEnd&&this.config.onAutoReconnectEnd(o)})):this.config.onClose&&this.config.onClose();break;case"onerror":this.config.onError&&this.config.onError();break;case"onopen":{this.setState(s.CONNECTTED),this.config.onOpen&&this.config.onOpen();break}default:break}}_startTicker(){this._ticker||(this._ticker=setInterval(this._tick.bind(this),this.config.tickInterval))}_tick(){let e=this.config.protocolTimeout;if(e>0){let t=Date.now();for(let i of this._listeners.values())!i.timeout&&t-i.time>e&&(i.timeout=!0,a(` - Error: ${c.PROTOCOL_TIMEOUT} : ${i.msgName} seqId: ${i.seqId}`),this.config.onProtocolTimeout&&this.config.onProtocolTimeout(i))}switch(this._state){case s.CONNECTING:{Date.now()-this._connectTime>this.config.connectTimeout&&(a(` - Error: ${c.CONNECT_TIMEOUT} connectTimeout: ${this.config.connectTimeout}`),this.close(),this.config.onConnectTimeout&&this.config.onConnectTimeout(this),this.config.onClose&&this.config.onClose());break}case s.CONNECTTED:{let t=Date.now();t-this._lastHeartbeatResponseTime>this.config.heartbeatTimeout?(a(` - Error: ${c.HEARTBEAT_TIMEOUT} heartbeatTimeout: ${this.config.heartbeatTimeout}`),this.close(),this.config.onHeartbeatTimeout&&this.config.onHeartbeatTimeout(this),this.config.onClose&&this.config.onClose()):t-this._lastHeartbeatTime>this.config.heartbeatInterval&&this._sendHeartbeat();break}}}_stopTicker(){this._ticker&&(clearInterval(this._ticker),this._ticker=null)}_sendHeartbeat(){this._lastHeartbeatTime=Date.now(),this.send(y[1],{clientTime:Date.now()},(e,t)=>{t.code===0?(this._lastHeartbeatResponseTime=Date.now(),t.serverTime?this._ping=t.serverTime-Date.now():this.config.debugMode&&a(` Heartbeat ${JSON.stringify(t)}`)):a(` - Error: ${c.HEARTBEAT_FAILED} heartbeatFailed: ${t}`),this.config.onHeartbeat&&this.config.onHeartbeat(t)})}};s.VERSION="1.4.1",s.NONE=0,s.DISCONNECTED=1,s.CONNECTING=2,s.CONNECTTED=3,s.protobuf=E.protobuf,s._instance=null;var m=s;E.WSocketClient=m;typeof module!="undefined"&&typeof module.exports!="undefined"&&(module.exports=m);})();
