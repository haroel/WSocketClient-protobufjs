(()=>{var _=function(...n){console.log("WSocket",...n)},m=function(...n){console.error("WSocket",...n)},S=1,b=class b{constructor(t,e){this.url="";this.ws=null;this._callback=null;this.opts={retry:1,interval:1e3,cacert:""};this._reconnectTimer=null;this.url=t,this.opts=e,this.connect(t)}destroy(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._callback=null,this.close()}connect(t){if(t&&(this.url=t),this.ws){let o=this.ws;this.ws=null,o.close()}_(`connect ${this.url}`);let e=b.class,i=null;this.opts.cacert?(i=new e(this.url,[],this.opts.cacert),_("cacert",this.opts.cacert)):i=new e(this.url),i.binaryType="arraybuffer",i.onopen=o=>{this.onopen(i,o)},i.onmessage=o=>{this.onmessage(i,o)},i.onclose=o=>{this.onclose(i,o)},i.onerror=o=>{this.onerror(i,o)},i.uuid=S++,this.ws=i}_reconnect(){this.opts.retry>0&&(_("reconnect ",this.opts.retry,this.opts.interval),this._reconnectTimer=setTimeout(()=>{clearTimeout(this._reconnectTimer),this._reconnectTimer=null,this.opts.retry--,this.connect(this.url)},this.opts.interval))}send(t){t.byteLength<1&&m("Buffer.size  == 0"),this.ws?this.ws.send(t):m("ws null!")}close(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null);let t=this.ws;this.ws=null,t&&t.close()}on(t){this._callback=t}onopen(t,e){_(`${this.url} onopen ${t.uuid} `),this.ws&&t.uuid===this.ws.uuid&&(this.opts.retry=0,this._callback("onopen",e))}onerror(t,e){if(m(` ${this.url} onerror`,e),this.ws&&t.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._callback("onerror",e)}}onclose(t,e){if(_(`${this.url} onclose   `,e),this.ws&&t.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._callback("onclose",e)}}onmessage(t,e){this.ws&&t.uuid===this.ws.uuid&&this._callback("onmessage",e.data)}};b.class=WebSocket;var E=b;var d=typeof GameGlobal!="undefined"?GameGlobal:typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:Object.create(null),r={CALL_SET_CONFIG_FIRST:1e5,CONNECTING_REPEAT_ERROR:100001,CONNECT_TIMEOUT:100002,PROTOCOL_TIMEOUT:100003,HEARTBEAT_TIMEOUT:100004,HEARTBEAT_FAILED:100005,CONNECTING_NOW:100006,PROTO_PARSE_ERROR:2e5,CSV_ERROR:200001,CSV_NO_RESPONSE:200002,CMDMERGE_NOT_FOUND:200003,EXTERNAL_MESSAGE_NOT_FOUND:200004,ENCODE_MESSAGE_FAILED:200005,DECODE_MESSAGE_FAILED:200006,BUILDER_BUILD_FAILED:200007};var I=function(...n){console.log("WSocketProtoBuf",...n)},u=function(...n){console.error("WSocketProtoBuf",...n)};function N(n,t){if(n!=null){if(Array.isArray(n))for(let e=0;e<n.length;e++)t.isLong(n[e])?n[e]=n[e].toNumber():typeof n[e]=="object"&&n[e]!==null&&N(n[e],t);else if(typeof n=="object")for(let e of Object.keys(n))t.isLong(n[e])?n[e]=n[e].toNumber():typeof n[e]=="object"&&n[e]!==null&&N(n[e],t)}}var T=class{constructor(t){this.protobuf=null;this.protoPackage="";this.Builder=null;this.encryptUtils=null;this.proto_define=null;this.proto_configs=null;this.protobuf=t,this.Builder=new this.protobuf.Builder}setConfig(t,e){this.protoPackage=e.proto_define.package,this.proto_define=e.proto_define,this.proto_configs=e.proto_configs;let i=this.protobuf.loadJson(this.proto_define,this.Builder,t),o=this.Builder.build();this.Builder.build(this.protoPackage)||I(` - Error: ${r.PROTO_PARSE_ERROR} protoName: ${t} protoPackage: ${this.protoPackage}`)}getProtoConfig(t){return this.proto_configs.get(t)}getMessageCMDMerge(t){for(let[e,i]of this.proto_configs.entries())if(i[1]===t)return e;return 0}encodeObjectToMessage(t,e){try{let i=this.Builder.build(this.protoPackage);if(!i)return u(` - Error: ${r.BUILDER_BUILD_FAILED} protoPackage: ${this.protoPackage}`),null;let o=i[t];return o?new o(e):(u(` - Error: ${r.DECODE_MESSAGE_FAILED} msgName: ${t}`),null)}catch(i){u(` - Error: ${r.ENCODE_MESSAGE_FAILED} error: ${i.toString()}`)}return null}encodeExternalMessage(t,e,i){try{let c=this.Builder.build(this.protoPackage).ExternalMessage;c||u(` - Error: ${r.EXTERNAL_MESSAGE_NOT_FOUND} protoPackage: ${this.protoPackage}`);let l=t==="PingReq"||t==="PingResp"?0:1,k=this.getMessageCMDMerge(t);k===0&&t!=="PingReq"&&t!=="PingResp"&&u(` - Error: ${r.CMDMERGE_NOT_FOUND} msgName: ${t}`);let f=this.encodeObjectToMessage(t,i);f||u(` - Error: ${r.ENCODE_MESSAGE_FAILED} msgName: ${t}`);let g={cmdCode:l,protocolSwitch:0,cmdMerge:k,responseStatus:0,validMsg:"",data:f.encode().toBuffer(),seqId:e},h=new c(g).encode().toBuffer();return this.encryptUtils&&(h.byteLength>0||h.length>0)?this.encryptUtils.AESEncData(h):h}catch(o){throw u(` - Error: ${r.ENCODE_MESSAGE_FAILED} msgName: ${o.toString()}`),o}}decodeExternalMessage(t,e=!0){try{return e&&t.byteLength>0&&this.encryptUtils&&(t=this.encryptUtils.AESDecData(t)),this.decodeData("ExternalMessage",t)}catch(i){return u(` - Error: ${r.DECODE_MESSAGE_FAILED} error: ${i.toString()}`,i),null}}decodeData(t,e){try{let i=this.Builder.build(this.protoPackage);i||u(` - Error: ${r.BUILDER_BUILD_FAILED} protoPackage: ${this.protoPackage}`);let o=i[t];o||u(` - Error: ${r.DECODE_MESSAGE_FAILED} msgName: ${t}`);let c=o.decode(e);return N(c,this.protobuf.Long),c}catch(i){return u(` - Error: ${r.DECODE_MESSAGE_FAILED} error: ${i.toString()}`,i),null}}};var a=function(...n){console.log("WSocketClient",...n)};function p(n){return function(...t){console.log(n,...arguments)}}var D=["","PingReq","PingResp"],s=class s{constructor(){this.config={WebSocket,connectRetry:3,connectInterval:5e3,connectTimeout:1e4,protocolTimeout:1e4,heartbeatTimeout:15e3,heartbeatInterval:5e3,tickInterval:1e3,autoReconnect:!0,cacert:"",onStateChange:p("onStateChange"),onConnectTimeout:p("onConnectTimeout"),onAutoReconnectStart:p("onAutoReconnectStart"),onAutoReconnectEnd:p("onAutoReconnectEnd"),onProtocolTimeout:p("onProtocolTimeout"),onHeartbeatTimeout:p("onHeartbeatTimeout"),onHeartbeat:p("onHeartbeat"),onOpen:p("onOpen"),onClose:p("onClose"),onError:p("onError"),onMessage:function(t){}};this.protobufHelper=null;this._wsocket=null;this._callbacks=new Map;this._ntfCallbacks=new Map;this._connectCallback=null;this._ticker=null;this._state=s.NONE;this._ping=0;this._lastHeartbeatTime=0;this._lastHeartbeatResponseTime=0;this._connectTime=0;this._seqid=1;this._isProtoLoaded=!1;this._isInReconnect=!1}static getInstance(){return s._instance||(a("v",s.VERSION),s.protobuf=d.protobuf,s._instance=new s),s._instance}get wsocket(){return this._wsocket}get url(){return this._wsocket?this._wsocket.url:""}get isConnected(){return this._state===s.CONNECTTED}get isReconnecting(){return this._isInReconnect}get state(){return this._state}setState(t){if(this._state!==t){switch(a(`laststate: ${this._state}, new state: ${t}`),this._state=t,t){case s.DISCONNECTED:{this._stopTicker();let e=this._connectCallback;this._connectCallback=null,e&&e(!1,this);break}case s.CONNECTING:{this._connectTime=Date.now();break}case s.CONNECTTED:{this._seqid=1,this._isInReconnect=!1;let e=this._connectCallback;this._connectCallback=null,e&&e(!0,this),this._lastHeartbeatTime=Date.now(),this._lastHeartbeatResponseTime=this._lastHeartbeatTime,this._startTicker(),this._sendHeartbeat();break}}this.config.onStateChange&&this.config.onStateChange(t)}}get ping(){return this._ping}get serverTime(){return Date.now()+this._ping}reset(){this.close(),this._callbacks.clear(),this._ntfCallbacks.clear(),this._stopTicker(),this._connectCallback=null,this._wsocket=null,this._state=s.NONE,this._lastHeartbeatTime=0,this._connectTime=0,this._isProtoLoaded=!1,this.protobufHelper=null}setConfig(t){this.protobufHelper=new T(s.protobuf),this.protobufHelper.setConfig(t.protoName,{proto_define:t.proto_define,proto_configs:t.proto_configs}),this._isProtoLoaded=!0}connect(t,e){if(!this._isProtoLoaded)return a(`Error: ${r.CALL_SET_CONFIG_FIRST}`),e&&e(!1,this);if(this._state==s.CONNECTTED)return e&&e(!0,this);if(this._state==s.CONNECTING)return a(`Error: ${r.CONNECTING_REPEAT_ERROR}`),e&&e(!1,this);this._stopTicker(),this._connectCallback=e,this.setState(s.CONNECTING),this._wsocket?(this._wsocket.opts.interval=this.config.connectInterval,this._wsocket.opts.retry=this.config.connectRetry,this._wsocket.opts.cacert=this.config.cacert,this._wsocket.connect(t)):(this._wsocket=new E(t,{retry:this.config.connectRetry,interval:this.config.connectInterval,cacert:this.config.cacert}),this._wsocket.on(this._wsHandler.bind(this)))}close(t=-1){this._wsocket&&this._wsocket.close(),this._connectCallback=null,this._callbacks.clear(),this._stopTicker(),this.setState(s.DISCONNECTED)}send(t,e,i){switch(this._state){case s.CONNECTTED:{let o=this._seqid++,c=this.protobufHelper.encodeExternalMessage(t,o,e);if(c){a("send : ",t,o),this._wsocket.send(c);let l={seqId:o,time:Date.now(),msgName:t,sendTimeout:!1,callback:i};return this._callbacks.set(o,l),l}}case s.CONNECTING:{a(`Error: ${r.CONNECTING_NOW}`);break}default:}return i(null,null),null}onNTF(t,e,i=0){let o=this._ntfCallbacks.get(t);o?(o.push({priority:i,callback:e}),o.sort((c,l)=>l.priority-c.priority)):this._ntfCallbacks.set(t,[{priority:i,callback:e}])}offNTF(t,e){let i=this._ntfCallbacks.get(t);if(i)if(e&&typeof e=="function")for(let o=0;o<i.length;o++)i[o].callback===e&&(i.splice(o,1),i.length===0&&this._ntfCallbacks.delete(t));else i.length=0,this._ntfCallbacks.delete(t)}_data(t){let e=this.protobufHelper.decodeExternalMessage(t);if(e){this.config.onMessage&&this.config.onMessage(e);let i=null;if(e.cmdCode===0)i=D;else{let h=e.cmdMerge;i=this.protobufHelper.getProtoConfig(h),i||a(` -Error: ${r.CSV_ERROR}, cmdMerge: ${h}`)}let o=i[1],c=i[2],l=e.seqId;if(a("receive : ",c,l),c||a(` - Error: ${r.CSV_NO_RESPONSE}, seqId: ${l}`),!(this._callbacks.has(l)||this._ntfCallbacks.has(c)))return;let f={code:e.responseStatus,data:this.protobufHelper.decodeData(c,e.data),msgName:c},g=this._callbacks.get(l);g&&(this._callbacks.delete(l),g.callback(o,f),g.callback=null);let C=this._ntfCallbacks.get(c);if(C){let h=C.slice();for(let y of h)y.callback(c,f);h.length=0}}}_wsHandler(t,e){switch(t){case"onmessage":{this._data(e);break}case"onclose":let i=this._state;this.close(),this.config.onClose&&this.config.onClose(),i===s.CONNECTTED&&this.config.autoReconnect&&!this._isInReconnect&&(this._isInReconnect=!0,this.config.onAutoReconnectStart&&this.config.onAutoReconnectStart(),this.connect(this.url,(o,c)=>{this._isInReconnect=!1,this.config.onAutoReconnectEnd&&this.config.onAutoReconnectEnd(o)}));break;case"onerror":this.config.onError&&this.config.onError();break;case"onopen":{this.setState(s.CONNECTTED),this.config.onOpen&&this.config.onOpen();break}default:break}}_startTicker(){this._ticker||(this._ticker=setInterval(this._tick.bind(this),this.config.tickInterval))}_tick(){let t=this.config.protocolTimeout;if(t>0){let e=Date.now();for(let i of this._callbacks.values())!i.sendTimeout&&e-i.time>t&&(i.sendTimeout=!0,a(` - Error: ${r.PROTOCOL_TIMEOUT} : ${i.msgName} seqId: ${i.seqId}`),this.config.onProtocolTimeout&&this.config.onProtocolTimeout(i))}switch(this._state){case s.CONNECTING:{Date.now()-this._connectTime>this.config.connectTimeout&&(a(` - Error: ${r.CONNECT_TIMEOUT} connectTimeout: ${this.config.connectTimeout}`),this.close(),this.config.onConnectTimeout&&this.config.onConnectTimeout(),this.config.onClose&&this.config.onClose());break}case s.CONNECTTED:{let e=Date.now();e-this._lastHeartbeatResponseTime>this.config.heartbeatTimeout?(a(` - Error: ${r.HEARTBEAT_TIMEOUT} heartbeatTimeout: ${this.config.heartbeatTimeout}`),this.close(),this.config.onHeartbeatTimeout&&this.config.onHeartbeatTimeout(),this.config.onClose&&this.config.onClose()):e-this._lastHeartbeatTime>this.config.heartbeatInterval&&this._sendHeartbeat();break}}}_stopTicker(){this._ticker&&(clearInterval(this._ticker),this._ticker=null)}_sendHeartbeat(){this._lastHeartbeatTime=Date.now(),this.send("PingReq",{clientTime:Date.now()},(t,e)=>{e.code===0?(this._lastHeartbeatResponseTime=Date.now(),a(" serverTime : ",e.serverTime),this._ping=e.serverTime-Date.now()):a(` - Error: ${r.HEARTBEAT_FAILED} heartbeatFailed: ${e}`),this.config.onHeartbeat&&this.config.onHeartbeat()})}};s.VERSION="1.1",s.NONE=0,s.DISCONNECTED=1,s.CONNECTING=2,s.CONNECTTED=3,s.protobuf=d.protobuf,s._instance=null;var O=s;d.WSocketClient=O;})();
