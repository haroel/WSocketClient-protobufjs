(()=>{var _=function(...o){console.log("WSocket",...o)},C=function(...o){console.error("WSocket",...o)},S=1,b=class b{constructor(e,t){this.url="";this.ws=null;this._eventcallback=null;this.opts={retry:1,interval:1e3};this._reconnectTimer=null;this.url=e,this.opts=t,this.connect(e)}destroy(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._eventcallback=null,this.close()}connect(e){if(e&&(this.url=e),this.ws){let i=this.ws;this.ws=null,i.close()}_(`connect ${this.url}`);let t=new b.class(this.url);t.binaryType="arraybuffer",t.onopen=i=>{this.onopen(t,i)},t.onmessage=i=>{this.onmessage(t,i)},t.onclose=i=>{this.onclose(t,i)},t.onerror=i=>{this.onerror(t,i)},t.uuid=S++,this.ws=t}_reconnect(){this.opts.retry>0&&(_("reconnect ",this.opts.retry,this.opts.interval),this._reconnectTimer=setTimeout(()=>{clearTimeout(this._reconnectTimer),this._reconnectTimer=null,this.opts.retry--,this.connect(this.url)},this.opts.interval))}send(e){e.byteLength<1&&C("Buffer.size  == 0"),this.ws?this.ws.send(e):C("ws null!")}close(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null);let e=this.ws;this.ws=null,e&&e.close()}on(e){this._eventcallback=e}onopen(e,t){_(`${this.url} onopen ${e.uuid} `),this.ws&&e.uuid===this.ws.uuid&&(this.opts.retry=0,this._eventcallback("onopen",t))}onerror(e,t){if(C(` ${this.url} onerror`,t),this.ws&&e.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._eventcallback("onerror",t)}}onclose(e,t){if(_(`${this.url} onclose   `,t),this.ws&&e.uuid===this.ws.uuid){if(this.opts.retry>0)return this._reconnect();this._eventcallback("onclose",t)}}onmessage(e,t){this.ws&&e.uuid===this.ws.uuid&&this._eventcallback("onmessage",t.data)}};b.class=WebSocket;var E=b;var d=typeof GameGlobal!="undefined"?GameGlobal:typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:Object.create(null),r={CALL_SET_CONFIG_FIRST:1e5,CONNECTING_REPEAT_ERROR:100001,CONNECT_TIMEOUT:100002,PROTOCOL_TIMEOUT:100003,HEARTBEAT_TIMEOUT:100004,HEARTBEAT_FAILED:100005,PROTO_PARSE_ERROR:2e5,CSV_ERROR:200001,CSV_NO_RESPONSE:200002,CMDMERGE_NOT_FOUND:200003,EXTERNAL_MESSAGE_NOT_FOUND:200004,ENCODE_MESSAGE_FAILED:200005,DECODE_MESSAGE_FAILED:200006,BUILDER_BUILD_FAILED:200007};var D=function(...o){console.log("WSocketProtoBuf",...o)},u=function(...o){console.error("WSocketProtoBuf",...o)};function y(o,e){if(o!=null){if(Array.isArray(o))for(let t=0;t<o.length;t++)o[t]instanceof e?o[t]=o[t].toNumber():typeof o[t]=="object"&&o[t]!==null&&y(o[t],e);else if(typeof o=="object")for(let t of Object.keys(o))o[t]instanceof e?o[t]=o[t].toNumber():typeof o[t]=="object"&&o[t]!==null&&y(o[t],e)}}var T=class{constructor(e,t){this.protobuf=null;this.protoPackage="";this.Builder=null;this.encryptUtils=null;this.proto_define=null;this.proto_configs=null;this.protoPackage=e,this.protobuf=t,this.Builder=new this.protobuf.Builder}setConfig(e,t){this.proto_define=t.proto_define,this.proto_configs=t.proto_configs;let i=this.protobuf.loadJson(this.proto_define,this.Builder,e),s=this.Builder.build();this.Builder.build(this.protoPackage)||D(` - Error: ${r.PROTO_PARSE_ERROR} protoName: ${e} protoPackage: ${this.protoPackage}`)}getProtoConfig(e){return this.proto_configs.get(e)}getMessageCMDMerge(e){for(let[t,i]of this.proto_configs.entries())if(i[1]===e)return t;return 0}encodeObjectToMessage(e,t){try{let i=this.Builder.build(this.protoPackage);if(!i)return u(` - Error: ${r.BUILDER_BUILD_FAILED} protoPackage: ${this.protoPackage}`),null;let s=i[e];return s?new s(t):(u(` - Error: ${r.DECODE_MESSAGE_FAILED} msgName: ${e}`),null)}catch(i){u(` - Error: ${r.ENCODE_MESSAGE_FAILED} error: ${i.toString()}`)}return null}encodeExternalMessage(e,t,i){try{let c=this.Builder.build(this.protoPackage).ExternalMessage;c||u(` - Error: ${r.EXTERNAL_MESSAGE_NOT_FOUND} protoPackage: ${this.protoPackage}`);let a=e==="PingReq"||e==="PingResp"?0:1,k=this.getMessageCMDMerge(e);k===0&&e!=="PingReq"&&e!=="PingResp"&&u(` - Error: ${r.CMDMERGE_NOT_FOUND} msgName: ${e}`);let f=this.encodeObjectToMessage(e,i);f||u(` - Error: ${r.ENCODE_MESSAGE_FAILED} msgName: ${e}`);let g={cmdCode:a,protocolSwitch:0,cmdMerge:k,responseStatus:0,validMsg:"",data:f.encode().toBuffer(),seqId:t},h=new c(g).encode().toBuffer();return this.encryptUtils&&(h.byteLength>0||h.length>0)?this.encryptUtils.AESEncData(h):h}catch(s){throw u(` - Error: ${r.ENCODE_MESSAGE_FAILED} msgName: ${s.toString()}`),s}}decodeExternalMessage(e,t=!0){try{return t&&e.byteLength>0&&this.encryptUtils&&(e=this.encryptUtils.AESDecData(e)),this.decodeData("ExternalMessage",e)}catch(i){return u(` - Error: ${r.DECODE_MESSAGE_FAILED} error: ${i.toString()}`,i),null}}decodeData(e,t){try{let i=this.Builder.build(this.protoPackage);i||u(` - Error: ${r.BUILDER_BUILD_FAILED} protoPackage: ${this.protoPackage}`);let s=i[e];s||u(` - Error: ${r.DECODE_MESSAGE_FAILED} msgName: ${e}`);let c=s.decode(t);return y(c,this.protobuf.Long),c}catch(i){return u(` - Error: ${r.DECODE_MESSAGE_FAILED} error: ${i.toString()}`,i),null}}};var l=function(...o){console.log("WSocketClient",...o)};function p(o){return function(...e){console.log(o,...arguments)}}var R=["","PingReq","PingResp"],n=class n{constructor(){this.config={WebSocket,connectRetry:3,connectInterval:5e3,connectTimeout:1e4,protocolTimeout:1e4,heartbeatTimeout:15e3,heartbeatInterval:5e3,autoReconnect:!0,onStateChange:p("onStateChange"),onConnectTimeout:p("onConnectTimeout"),onAutoReconnectStart:p("onAutoReconnectStart"),onAutoReconnectEnd:p("onAutoReconnectEnd"),onProtocolTimeout:p("onProtocolTimeout"),onHeartbeatTimeout:p("onHeartbeatTimeout"),onHeartbeat:p("onHeartbeat"),onOpen:p("onOpen"),onClose:p("onClose"),onError:p("onError"),onMessage:function(e){}};this.protobufHelper=null;this._wsocket=null;this._callbacks=new Map;this._ntfCallbacks=new Map;this._connectCallback=null;this._ticker=null;this._state=n.NONE;this._ping=0;this._lastHeartbeatTime=0;this._lastHeartbeatResponseTime=0;this._connectTime=0;this._seqid=1;this._isProtoLoaded=!1;this._isInReconnect=!1}static getInstance(){return n._instance||(n.protobuf=d.protobuf,n._instance=new n),n._instance}get wsocket(){return this._wsocket}get url(){return this._wsocket?this._wsocket.url:""}get isConnected(){return this._state===n.CONNECTTED}get isReconnecting(){return this._isInReconnect}get state(){return this._state}setState(e){if(this._state!==e){switch(l(`laststate: ${this._state}, new state: ${e}`),this._state=e,e){case n.DISCONNECTED:{this._stopTicker();let t=this._connectCallback;this._connectCallback=null,t&&t(!1,this);break}case n.CONNECTING:{this._connectTime=Date.now();break}case n.CONNECTTED:{this._seqid=1,this._isInReconnect=!1;let t=this._connectCallback;this._connectCallback=null,t&&t(!0,this),this._lastHeartbeatTime=Date.now(),this._lastHeartbeatResponseTime=this._lastHeartbeatTime,this._startTicker(),this._sendHeartbeat();break}}this.config.onStateChange&&this.config.onStateChange(e)}}get ping(){return this._ping}get serverTime(){return Date.now()+this._ping}reset(){this.close(),this._callbacks.clear(),this._ntfCallbacks.clear(),this._stopTicker(),this._connectCallback=null,this._wsocket=null,this._state=n.NONE,this._lastHeartbeatTime=0,this._connectTime=0,this._isProtoLoaded=!1,this.protobufHelper=null}setConfig(e){this.protobufHelper=new T(e.package,n.protobuf),this.protobufHelper.setConfig(e.protoName,{proto_define:e.proto_define,proto_configs:e.proto_configs}),this._isProtoLoaded=!0}connect(e,t){if(!this._isProtoLoaded)return l(`Error: ${r.CALL_SET_CONFIG_FIRST}`),t&&t(!1,this);if(this._state==n.CONNECTTED)return t&&t(!0,this);if(this._state==n.CONNECTING)return l(`Error: ${r.CONNECTING_REPEAT_ERROR}`),t&&t(!1,this);this._stopTicker(),this._connectCallback=t,this.setState(n.CONNECTING),this._wsocket?(this._wsocket.opts.interval=this.config.connectInterval,this._wsocket.opts.retry=this.config.connectRetry,this._wsocket.connect(e)):(this._wsocket=new E(e,{retry:this.config.connectRetry,interval:this.config.connectInterval}),this._wsocket.on(this._wsHandler.bind(this)))}close(e=-1){this._wsocket&&this._wsocket.close(),this._connectCallback=null,this._callbacks.clear(),this._stopTicker(),this.setState(n.DISCONNECTED)}send(e,t,i){switch(this._state){case n.CONNECTTED:{let s=this._seqid++,c=this.protobufHelper.encodeExternalMessage(e,s,t);if(c){l("send : ",e,s),this._wsocket.send(c);let a={seqId:s,time:Date.now(),msgName:e,callback:i};return this._callbacks.set(s,a),a}}case n.CONNECTING:break;default:}return i(null,null),null}onNTF(e,t,i=0){let s=this._ntfCallbacks.get(e);s?(s.push({priority:i,callback:t}),s.sort((c,a)=>a.priority-c.priority)):this._ntfCallbacks.set(e,[{priority:i,callback:t}])}offNTF(e,t){let i=this._ntfCallbacks.get(e);if(i)if(t&&typeof t=="function")for(let s=0;s<i.length;s++)i[s].callback===t&&(i.splice(s,1),i.length===0&&this._ntfCallbacks.delete(e));else i.length=0,this._ntfCallbacks.delete(e)}_data(e){let t=this.protobufHelper.decodeExternalMessage(e);if(t){this.config.onMessage&&this.config.onMessage(t);let i=null;if(t.cmdCode===0)i=R;else{let h=t.cmdMerge;i=this.protobufHelper.getProtoConfig(h),i||l(` -Error: ${r.CSV_ERROR}, cmdMerge: ${h}`)}let s=i[1],c=i[2],a=t.seqId;if(l("receive : ",c,a),c||l(` - Error: ${r.CSV_NO_RESPONSE}, seqId: ${a}`),!(this._callbacks.has(a)||this._ntfCallbacks.has(c)))return;let f={code:t.responseStatus,data:this.protobufHelper.decodeData(c,t.data),msgName:c},g=this._callbacks.get(a);g&&(this._callbacks.delete(a),g.callback(s,f),g.callback=null);let m=this._ntfCallbacks.get(c);if(m){let h=m.slice();for(let O of h)O.callback(c,f);h.length=0}}}_wsHandler(e,t){switch(e){case"onmessage":{this._data(t);break}case"onclose":let i=this._state;this.close(),this.config.onClose&&this.config.onClose(),i===n.CONNECTTED&&this.config.autoReconnect&&!this._isInReconnect&&(this._isInReconnect=!0,this.config.onAutoReconnectStart&&this.config.onAutoReconnectStart(),this.connect(this.url,(s,c)=>{this._isInReconnect=!1,this.config.onAutoReconnectEnd&&this.config.onAutoReconnectEnd(s)}));break;case"onerror":this.config.onError&&this.config.onError();break;case"onopen":{this.setState(n.CONNECTTED),this.config.onOpen&&this.config.onOpen();break}default:break}}_startTicker(){this._ticker||(this._ticker=setInterval(this._tick.bind(this),1e3))}_tick(){let e=this.config.protocolTimeout;if(e>0){let t=Date.now();for(let i of this._callbacks.values())t-i.time>e&&(l(` - Error: ${r.PROTOCOL_TIMEOUT} : ${i.msgName} seqId: ${i.seqId}`),this.config.onProtocolTimeout&&this.config.onProtocolTimeout(i))}switch(this._state){case n.CONNECTING:{Date.now()-this._connectTime>this.config.connectTimeout&&(l(` - Error: ${r.CONNECT_TIMEOUT} connectTimeout: ${this.config.connectTimeout}`),this.config.onConnectTimeout&&this.config.onConnectTimeout());break}case n.CONNECTTED:{let t=Date.now();t-this._lastHeartbeatTime>this.config.heartbeatInterval?this._sendHeartbeat():t-this._lastHeartbeatResponseTime>this.config.heartbeatTimeout&&(l(` - Error: ${r.HEARTBEAT_TIMEOUT} heartbeatTimeout: ${this.config.heartbeatTimeout}`),this.close(),this.config.onHeartbeatTimeout&&this.config.onHeartbeatTimeout());break}}}_stopTicker(){this._ticker&&(clearInterval(this._ticker),this._ticker=null)}_sendHeartbeat(){this._lastHeartbeatTime=Date.now(),this.send("PingReq",{clientTime:Date.now()},(e,t)=>{t.code===0?(this._lastHeartbeatResponseTime=Date.now(),l(" serverTime : ",t.serverTime),this._ping=t.serverTime-Date.now()):l(` - Error: ${r.HEARTBEAT_FAILED} heartbeatFailed: ${t}`),this.config.onHeartbeat&&this.config.onHeartbeat()})}};n.NONE=0,n.DISCONNECTED=1,n.CONNECTING=2,n.CONNECTTED=3,n.protobuf=d.protobuf,n._instance=null;var N=n;d.WSocketClient=N;})();
