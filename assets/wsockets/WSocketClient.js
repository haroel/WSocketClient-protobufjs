(()=>{var _=function(...o){console.log("WSocket",...o)},w=function(...o){console.error("WSocket",...o)},D=1,d=class d{constructor(t,e){this.url="";this.ws=null;this._callback=null;this.opts={retry:1,interval:1e3,cacert:""};this._reconnectTimer=null;this.url=t,this.opts=e,this.connect(t)}destroy(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._callback=null,this.close()}connect(t){if(t&&(this.url=t),this.ws){let n=this.ws;this.ws=null,n.close()}_(`connect ${this.url} ${JSON.stringify(this.opts)}`);let e=d.class,i=null;this.opts.cacert?(i=new e(this.url,[],this.opts.cacert),_("cacert",this.opts.cacert)):i=new e(this.url),i.binaryType="arraybuffer",i.onopen=n=>{this.onopen(i,n)},i.onmessage=n=>{this.onmessage(i,n)},i.onclose=n=>{this.onclose(i,n)},i.onerror=n=>{this.onerror(i,n)},i.uuid=D++,this.ws=i}_reconnect(){return this._reconnectTimer?!0:this.opts.retry>0?(this.opts.retry--,this._reconnectTimer=setTimeout(()=>{clearTimeout(this._reconnectTimer),this._reconnectTimer=null,this.connect(this.url)},this.opts.interval),!0):!1}send(t){this.ws&&this.ws.send(t)}close(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null);let t=this.ws;this.ws=null,t&&t.close()}on(t){this._callback=t}onopen(t,e){_(`${this.url} onopen ${t.uuid} `),this.ws&&t.uuid===this.ws.uuid&&(this.opts.retry=0,this._callback("onopen",e))}onerror(t,e){w(` ${this.url} onerror`,e),this.ws&&t.uuid===this.ws.uuid&&(this._reconnect()||this._callback("onerror",e))}onclose(t,e){_(`${this.url} onclose   `,e),this.ws&&t.uuid===this.ws.uuid&&(this._reconnect()||this._callback("onclose",e))}onmessage(t,e){this.ws&&t.uuid===this.ws.uuid&&this._callback("onmessage",e.data)}};d.class=WebSocket;var g=d;var b=typeof GameGlobal!="undefined"?GameGlobal:typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:Object.create(null),c={CALL_ERROR:1e5,CONNECTING_REPEAT_ERROR:100001,CONNECT_TIMEOUT:100002,PROTOCOL_TIMEOUT:100003,HEARTBEAT_TIMEOUT:100004,HEARTBEAT_FAILED:100005,CONNECTING_NOW:100006,PROTO_PARSE_ERROR:2e5,CSV_ERROR:200001,CSV_NO_RESPONSE:200002,CMDMERGE_NOT_FOUND:200003,MESSAGE_NOT_FOUND:200004,NO_HANDLER:200005,ENCODE_FAILED:200010,DECODE_FAILED:200011};var I=function(...o){console.log("WSocketProtoBuf",...o)},h=function(...o){console.error("WSocketProtoBuf",...o)};function C(o,t){if(o!=null){if(Array.isArray(o))for(let e=0;e<o.length;e++)t.isLong(o[e])?o[e]=o[e].toNumber():typeof o[e]=="object"&&o[e]!==null&&C(o[e],t);else if(typeof o=="object")for(let e of Object.keys(o))t.isLong(o[e])?o[e]=o[e].toNumber():typeof o[e]=="object"&&o[e]!==null&&C(o[e],t)}}function y(o){return o==="PingReq"||o==="PingResp"}var E=class{constructor(t){this.protobuf=null;this.protoPackage="";this.Builder=null;this.encryptUtils=null;this.proto_define=null;this.proto_configs=null;this.protobuf=t,this.Builder=new this.protobuf.Builder}setConfig(t,e){this.protoPackage=e.proto_define.package,this.proto_define=e.proto_define,this.proto_configs=e.proto_configs;let i=this.protobuf.loadJson(this.proto_define,this.Builder,t),n=this.Builder.build();this.Builder.build(this.protoPackage)||I(` - Error: ${c.PROTO_PARSE_ERROR} protoName: ${t} protoPackage: ${this.protoPackage}`)}getProtoConfig(t){return this.proto_configs.get(t)}getCMDMerge(t){for(let[e,i]of this.proto_configs.entries())if(i[1]===t)return e;return 0}encodeObjectToMessage(t,e){try{let i=this.Builder.build(this.protoPackage);if(!i)throw new Error(`${this.protoPackage} builder build failed`);let n=i[t];return n?new n(e):(h(` - Error: ${c.DECODE_FAILED} msgName: ${t}`),null)}catch(i){h(` - Error: ${c.ENCODE_FAILED} error: ${i.toString()}`)}return null}encodeRequest(t,e,i){try{let r=this.Builder.build(this.protoPackage).ExternalMessage;r||h(` - Error: ${c.MESSAGE_NOT_FOUND} protoPackage: ${this.protoPackage}`);let l=y(t)?0:1,k=this.getCMDMerge(t);k===0&&!y(t)&&h(` - Error: ${c.CMDMERGE_NOT_FOUND} msgName: ${t}`);let p=this.encodeObjectToMessage(t,i);p||h(` - Error: ${c.ENCODE_FAILED} msgName: ${t}`);let f={cmdCode:l,protocolSwitch:0,cmdMerge:k,responseStatus:0,validMsg:"",data:p.encode().toBuffer(),seqId:e},u=new r(f).encode().toBuffer();return this.encryptUtils&&(u.byteLength>0||u.length>0)?this.encryptUtils.AESEncData(u):u}catch(n){throw h(` - Error: ${c.ENCODE_FAILED} msgName: ${n.toString()}`),n}}decodeResponse(t,e=!0){try{return e&&t.byteLength>0&&this.encryptUtils&&(t=this.encryptUtils.AESDecData(t)),this.decodeData("ExternalMessage",t)}catch(i){return h(` - Error: ${c.DECODE_FAILED} error: ${i.toString()}`,i),null}}decodeData(t,e){try{let i=this.Builder.build(this.protoPackage);if(!i)throw new Error(`${this.protoPackage} builder build failed`);let n=i[t];n||h(` - Error: ${c.DECODE_FAILED} msgName: ${t}`);let r=n.decode(e);return C(r,this.protobuf.Long),r}catch(i){return h(` - Error: ${c.DECODE_FAILED} error: ${i.toString()}`,i),null}}};var a=function(...o){console.log("WSocketClient",...o)};function T(o){return function(...t){console.log(o,...arguments)}}var O=["","PingReq","PingResp"],s=class s{constructor(){this.config={debugMode:!1,WebSocket,connectRetry:3,connectInterval:3e3,connectTimeout:1e4,protocolTimeout:1e4,heartbeatTimeout:15e3,heartbeatInterval:5e3,tickInterval:1e3,autoReconnect:!0,cacert:"",onConnected:function(t){},onDisconnect:function(t,e){},onAutoReconnectStart:T("onAutoReconnectStart"),onProtocolTimeout:T("onProtocolTimeout"),onHeartbeat:T("onHeartbeat"),onStateChange:T("onStateChange")};this.protobufUtil=null;this._wsocket=null;this._listeners=new Map;this._on_listeners=new Map;this._connectCallback=null;this._ticker=null;this._state=s.NONE;this._ping=0;this._lastHeartbeatTime=0;this._lastHeartbeatResponseTime=0;this._connectTime=0;this._seqid=1;this._isProtoLoaded=!1;this._isInReconnect=!1}static getInstance(){return s._instance||(a("v",s.VERSION),s.protobuf=b.protobuf,s._instance=new s),s._instance}get wsocket(){return this._wsocket}get url(){return this._wsocket?this._wsocket.url:""}get isConnected(){return this._state===s.CONNECTTED}get isReconnecting(){return this._isInReconnect}_invokeConnect(t){let e=this._connectCallback;this._connectCallback=null,e&&e(t,this)}get state(){return this._state}get ping(){return this._ping}get serverTime(){return Date.now()+this._ping}reset(){this._connectCallback=null,this._listeners.clear(),this._on_listeners.clear(),this.close(),this._stopTicker(),this.protobufUtil=null,this._wsocket=null,this._state=s.NONE,this._lastHeartbeatTime=0,this._connectTime=0,this._isInReconnect=!1,this._isProtoLoaded=!1}setProtoConfig(t){this.protobufUtil=new E(s.protobuf),this.protobufUtil.setConfig(t.protoName,t),this._isProtoLoaded=!0}setState(t){if(this._state===t)return;let e={from:this._state,to:t};switch(this._state=t,t){case s.DISCONNECTED:{this._listeners.clear(),this._stopTicker(),this._invokeConnect(!1);break}case s.CONNECTING:{this._connectTime=Date.now(),this._startTicker();break}case s.CONNECTTED:{this._seqid=1,this.config.onConnected(this.isReconnecting?2:1),this._invokeConnect(!0),this._lastHeartbeatResponseTime=Date.now(),this._sendHeartbeat();break}}this.config.debugMode&&a(`State: ${JSON.stringify(e)}`),this.config.onStateChange(e)}connect(t,e){if(!this._isProtoLoaded)return a(`Error: ${c.CALL_ERROR}`),e&&e(!1,this);let i=this.url;if(i&&i!==t)a(`Error: ${i} != ${t}`),this._invokeConnect(!1),this.close();else{if(this._state==s.CONNECTTED)return e&&e(!0,this);if(this._state==s.CONNECTING)return a(`Error: ${c.CONNECTING_REPEAT_ERROR}`),e&&e(!1,this)}this._connectCallback=e,this.setState(s.CONNECTING),this._wsocket?(this._wsocket.opts.interval=this.config.connectInterval,this._wsocket.opts.retry=this.config.connectRetry,this._wsocket.opts.cacert=this.config.cacert,this._wsocket.connect(t)):(this._wsocket=new g(t,{retry:this.config.connectRetry,interval:this.config.connectInterval,cacert:this.config.cacert}),this._wsocket.on(this._wsHandler.bind(this)))}_disconnect(){this._wsocket&&this._wsocket.close(),this._listeners.clear(),this._stopTicker(),this.setState(s.DISCONNECTED)}close(){this._disconnect(),this.config.onDisconnect(11,"close")}send(t,e,i){switch(this._state){case s.CONNECTTED:{let n=this._seqid++,r=this.protobufUtil.encodeRequest(t,n,e);if(r){this.config.debugMode&&a("send : ",t,n),this._wsocket.send(r);let l={seqId:n,time:Date.now(),msgName:t,timeout:!1,callback:i};return this._listeners.set(n,l),l}}case s.CONNECTING:{a(`Error: ${c.CONNECTING_NOW}`);break}default:}return i(null,null),null}onNTF(t,e,i=0){let n=this._on_listeners.get(t);n?(n.push({priority:i,callback:e}),n.sort((r,l)=>l.priority-r.priority)):this._on_listeners.set(t,[{priority:i,callback:e}])}offNTF(t,e){let i=this._on_listeners.get(t);if(i)if(e&&typeof e=="function")for(let n=0;n<i.length;n++)i[n].callback===e&&(i.splice(n,1),i.length===0&&this._on_listeners.delete(t));else i.length=0,this._on_listeners.delete(t)}_data(t){let e=this.protobufUtil.decodeResponse(t);if(e){let i=null;if(e.cmdCode===0)i=O;else{let u=e.cmdMerge;i=this.protobufUtil.getProtoConfig(u),i||a(` -Error: ${c.CSV_ERROR}, cmdMerge: ${u}`)}let n=i[1],r=i[2],l=e.seqId;if(this.config.debugMode&&a("receive : ",r,l),r||a(` - Error: ${c.CSV_NO_RESPONSE} ${r} - ${l}`),!(this._listeners.has(l)||this._on_listeners.has(r))){this.config.debugMode&&a(`${c.NO_HANDLER} ${r} - ${l}`);return}let p={code:e.responseStatus,data:this.protobufUtil.decodeData(r,e.data),msgName:r},f=this._listeners.get(l);f&&(this._listeners.delete(l),f.callback(n,p),f.callback=null);let N=this._on_listeners.get(r);if(N){let u=N.slice();for(let R of u)R.callback(r,p)}}}_checkReconnect(t){t===s.CONNECTTED&&this.config.autoReconnect&&!this._isInReconnect&&(this._isInReconnect=!0,a("onAutoReconnectStart"),this.config.onAutoReconnectStart(),this.connect(this.url,(e,i)=>{a("autoReconnect "+e),this._isInReconnect=!1}))}_wsHandler(t,e){let i=this._state,n=this.isReconnecting;switch(t){case"onmessage":{this._data(e);break}case"onclose":{this._disconnect(),this.config.onDisconnect(n?10:11,e),this._checkReconnect(i);break}case"onerror":{this._disconnect(),this.config.onDisconnect(n?10:12,e),this._checkReconnect(i);break}case"onopen":{this.setState(s.CONNECTTED);break}default:break}}_startTicker(){this._ticker||(this._ticker=setInterval(this._tick.bind(this),this.config.tickInterval))}_tick(){let t=this.config.protocolTimeout;if(t>0){let n=Date.now();for(let r of this._listeners.values())!r.timeout&&n-r.time>t&&(r.timeout=!0,a(` - Error: ${c.PROTOCOL_TIMEOUT} : ${r.msgName} seqId: ${r.seqId}`),this.config.onProtocolTimeout&&this.config.onProtocolTimeout(r))}let e=this._state,i=this.isReconnecting;switch(e){case s.CONNECTING:{Date.now()-this._connectTime>this.config.connectTimeout&&(a(` - Error: ${c.CONNECT_TIMEOUT}`),this._disconnect(),this.config.onDisconnect(i?2:1,"reconnectTimeout"));break}case s.CONNECTTED:{let n=Date.now();n-this._lastHeartbeatResponseTime>this.config.heartbeatTimeout?(a(` - Error: ${c.HEARTBEAT_TIMEOUT}`),this._disconnect(),this.config.onDisconnect(3,"heartbeatTimeout"),this._checkReconnect(e)):n-this._lastHeartbeatTime>this.config.heartbeatInterval&&this._sendHeartbeat();break}}}_stopTicker(){this._ticker&&(clearInterval(this._ticker),this._ticker=null)}_sendHeartbeat(){this._lastHeartbeatTime=Date.now(),this.send(O[1],{clientTime:Date.now()},(t,e)=>{e.code===0?(this._lastHeartbeatResponseTime=Date.now(),e.serverTime?this._ping=e.serverTime-Date.now():this.config.debugMode&&a(` Heartbeat ${JSON.stringify(e)}`)):a(` - Error: ${c.HEARTBEAT_FAILED} heartbeatFailed: ${e}`),this.config.onHeartbeat&&this.config.onHeartbeat(e)})}};s.VERSION="1.4.3",s.NONE=0,s.DISCONNECTED=1,s.CONNECTING=2,s.CONNECTTED=3,s.protobuf=b.protobuf,s._instance=null;var m=s;b.WSocketClient=m;typeof module!="undefined"&&typeof module.exports!="undefined"&&(module.exports=m);})();
