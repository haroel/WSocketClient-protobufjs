(()=>{var g=function(...s){console.log("WSocket",...s)},v=function(...s){console.error("WSocket",...s)},R=1,_=class _{constructor(e,t){this.url="";this.ws=null;this._callback=null;this.opts={retry:1,interval:1e3,cacert:""};this._reconnectTimer=null;this.url=e,this.opts=t,this.connect(e)}destroy(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null),this._callback=null,this.close()}connect(e){if(e&&(this.url=e),this.ws){let n=this.ws;this.ws=null,n.close()}g(`connect ${this.url} ${JSON.stringify(this.opts)}`);let t=_.class,i=null;this.opts.cacert?(i=new t(this.url,[],this.opts.cacert),g("cacert",this.opts.cacert)):i=new t(this.url),i.binaryType="arraybuffer",i.onopen=n=>{this.onopen(i,n)},i.onmessage=n=>{this.onmessage(i,n)},i.onclose=n=>{this.onclose(i,n)},i.onerror=n=>{this.onerror(i,n)},i.uuid=R++,this.ws=i}_reconnect(){return this._reconnectTimer?!0:this.opts.retry>0?(this.opts.retry--,this._reconnectTimer=setTimeout(()=>{clearTimeout(this._reconnectTimer),this._reconnectTimer=null,this.connect(this.url)},this.opts.interval),!0):!1}send(e){this.ws&&this.ws.send(e)}close(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),this._reconnectTimer=null);let e=this.ws;this.ws=null,e&&e.close()}on(e){this._callback=e}onopen(e,t){g(`${this.url} onopen ${e.uuid} `),this.ws&&e.uuid===this.ws.uuid&&(this.opts.retry=0,this._callback("onopen",t))}onerror(e,t){v(` ${this.url} onerror`,t),this.ws&&e.uuid===this.ws.uuid&&(this._reconnect()||this._callback("onerror",t))}onclose(e,t){g(`${this.url} onclose   `,t),this.ws&&e.uuid===this.ws.uuid&&(this._reconnect()||this._callback("onclose",t))}onmessage(e,t){this.ws&&e.uuid===this.ws.uuid&&this._callback("onmessage",t.data)}};_.class=WebSocket;var d=_;var O=function(...s){console.log("WSocketProtoBuf",...s)},u=function(...s){console.error("WSocketProtoBuf",...s)};function k(s,e){if(s!=null){if(Array.isArray(s))for(let t=0;t<s.length;t++)e.isLong(s[t])?s[t]=s[t].toNumber():typeof s[t]=="object"&&s[t]!==null&&k(s[t],e);else if(typeof s=="object")for(let t of Object.keys(s))e.isLong(s[t])?s[t]=s[t].toNumber():typeof s[t]=="object"&&s[t]!==null&&k(s[t],e)}}function N(s){return s==="PingReq"||s==="PingResp"}var b=class{constructor(e){this.protobuf=null;this.protoPackage="";this.Builder=null;this.encryptUtils=null;this.proto_define=null;this.proto_configs=null;this.protobuf=e,this.Builder=new this.protobuf.Builder}setConfig(e,t){this.protoPackage=t.proto_define.package,this.proto_define=t.proto_define,this.proto_configs=t.proto_configs;let i=this.protobuf.loadJson(this.proto_define,this.Builder,e),n=this.Builder.build();this.Builder.build(this.protoPackage)||O(` - Error: 200000 protoName: ${e} protoPackage: ${this.protoPackage}`)}getProtoConfig(e){return this.proto_configs.get(e)}getCMDMerge(e){for(let[t,i]of this.proto_configs.entries())if(i[1]===e)return t;return 0}getMessage(e){let t=this.Builder.build(this.protoPackage);if(t){let i=t[e];if(i)return i;u(` - Proto Error: ${e} 404`)}else u(` - Proto Error: ${this.protoPackage} 404`);return null}encodeObjectToMessage(e,t){let i=this.getMessage(e);return i?new i(t):null}encodeRequest(e,t,i){try{let n=this.getMessage("ExternalMessage");if(!n)return null;let r=N(e)?0:1,a=this.getCMDMerge(e);a===0&&!N(e)&&u(` - Error: 200003 msgName: ${e}`);let y=this.encodeObjectToMessage(e,i);y||u(` - Error: 200010 msgName: ${e}`);let h={cmdCode:r,protocolSwitch:0,cmdMerge:a,responseStatus:0,validMsg:"",data:y.encode().toBuffer(),seqId:t},l=new n(h).encode().toBuffer();return this.encryptUtils&&(l.byteLength>0||l.length>0)?this.encryptUtils.AESEncData(l):l}catch(n){throw u(` - Error: 200010 msgName: ${n.toString()}`),n}}decodeResponse(e,t=!0){try{return t&&e.byteLength>0&&this.encryptUtils&&(e=this.encryptUtils.AESDecData(e)),this.decodeData("ExternalMessage",e)}catch(i){return u(` - Error: 200011 error: ${i.toString()}`,i),null}}decodeData(e,t){let i=this.getMessage(e);if(i){let n=i.decode(t);return k(n,this.protobuf.Long),n}return null}};var T=typeof GameGlobal!="undefined"?GameGlobal:typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:Object.create(null);var c=function(...s){console.log("WSocketClient",...s)};function m(s){return function(...e){console.log(s,...arguments)}}var C=["","PingReq","PingResp"],o=class o{constructor(){this.config={debugMode:!1,WebSocket,connectRetry:3,connectInterval:3e3,connectTimeout:1e4,protocolTimeout:1e4,heartbeatTimeout:15e3,heartbeatInterval:5e3,tickInterval:500,autoReconnect:!0,cacert:"",onConnected:function(e){},onDisconnect:function(e,t,i){},onAutoReconnectStart:m("onAutoReconnectStart"),onProtocolTimeout:m("onProtocolTimeout"),onHeartbeat:m("onHeartbeat"),onStateChange:m("onStateChange")};this.protobufUtil=null;this._wsocket=null;this._listeners=new Map;this._on_listeners=new Map;this._connectCallback=null;this._ticker=null;this._state=o.NONE;this._ping=0;this._lastHeartbeatTime=0;this._lastHeartbeatResponseTime=0;this._connectTime=0;this._seqid=1;this._isProtoLoaded=!1;this._isInReconnect=!1}static getInstance(){return o._instance||(c("v",o.VERSION),o.protobuf=T.protobuf,o._instance=new o),o._instance}get wsocket(){return this._wsocket}get url(){return this._wsocket?this._wsocket.url:""}get isConnected(){return this._state===o.CONNECTTED}get isReconnecting(){return this._isInReconnect}_invokeConnect(e){let t=this._connectCallback;this._connectCallback=null,t&&t(e,this)}get state(){return this._state}get ping(){return this._ping}get serverTime(){return Date.now()+this._ping}reset(){this._connectCallback=null,this._listeners.clear(),this._on_listeners.clear(),this.close(),this._stopTicker(),this.protobufUtil=null,this._wsocket=null,this._state=o.NONE,this._lastHeartbeatTime=0,this._connectTime=0,this._isInReconnect=!1,this._isProtoLoaded=!1}setProtoConfig(e){this.protobufUtil=new b(o.protobuf),this.protobufUtil.setConfig(e.protoName,e),this._isProtoLoaded=!0}setState(e){if(this._state===e)return;let t={from:this._state,to:e};switch(this._state=e,e){case o.DISCONNECTED:{this._listeners.clear(),this._stopTicker(),this._invokeConnect(!1);break}case o.CONNECTING:{this._connectTime=Date.now(),this._startTicker();break}case o.CONNECTTED:{this._seqid=1,this.config.onConnected(this.isReconnecting?2:1),this._invokeConnect(!0),this._lastHeartbeatResponseTime=Date.now(),this._sendHeartbeat();break}}this.config.debugMode&&c(`State: ${JSON.stringify(t)}`),this.config.onStateChange(t)}connect(e,t){if(!this._isProtoLoaded)return c("Error: 100000"),t&&t(!1,this);let i=this.url;if(i&&i!==e)c(`Error: ${i} != ${e}`),this._invokeConnect(!1),this.close();else{if(this._state==o.CONNECTTED)return t&&t(!0,this);if(this._state==o.CONNECTING)return c("Error: 100001"),t&&t(!1,this)}this._connectCallback=t,this.setState(o.CONNECTING),this._wsocket?(this._wsocket.opts.interval=this.config.connectInterval,this._wsocket.opts.retry=this.config.connectRetry,this._wsocket.opts.cacert=this.config.cacert,this._wsocket.connect(e)):(this._wsocket=new d(e,{retry:this.config.connectRetry,interval:this.config.connectInterval,cacert:this.config.cacert}),this._wsocket.on(this._wsHandler.bind(this)))}_disconnect(){this._wsocket&&this._wsocket.close(),this._listeners.clear(),this._stopTicker(),this.setState(o.DISCONNECTED)}close(){this.state!==o.DISCONNECTED&&(this._disconnect(),this.config.onDisconnect(11,!1,"close"))}send(e,t,i){switch(this._state){case o.CONNECTTED:{let n=this._seqid++,r=this.protobufUtil.encodeRequest(e,n,t);if(r){this.config.debugMode&&c("send : ",e,n),this._wsocket.send(r);let a={seqId:n,time:Date.now(),msgName:e,timeout:!1,callback:i};return this._listeners.set(n,a),a}}case o.CONNECTING:{c("Error: 100006");break}default:}return i(null,null),null}onNTF(e,t,i=0){let n=this._on_listeners.get(e);n?(n.push({priority:i,callback:t}),n.sort((r,a)=>a.priority-r.priority)):this._on_listeners.set(e,[{priority:i,callback:t}])}offNTF(e,t){let i=this._on_listeners.get(e);if(i)if(t&&typeof t=="function")for(let n=0;n<i.length;n++)i[n].callback===t&&(i.splice(n,1),i.length===0&&this._on_listeners.delete(e));else i.length=0,this._on_listeners.delete(e)}_data(e){let t=this.protobufUtil.decodeResponse(e);if(t){let i=null;if(t.cmdCode===0)i=C;else{let p=t.cmdMerge;i=this.protobufUtil.getProtoConfig(p),i||c(` -Error: 200001, cmdMerge: ${p}`)}let n=i[1],r=i[2],a=t.seqId;if(this.config.debugMode&&c("receive : ",r,a),r||c(` - Error: 200002 ${r} - ${a}`),!(this._listeners.has(a)||this._on_listeners.has(r))){this.config.debugMode&&c(`200005 ${r} - ${a}`);return}let h={code:t.responseStatus,data:this.protobufUtil.decodeData(r,t.data),msgName:r},f=this._listeners.get(a);f&&(this._listeners.delete(a),f.callback(n,h),f.callback=null);let l=this._on_listeners.get(r);if(l){let p=l.slice();for(let w of p)w.callback(r,h)}}}_needReconnect(e,t){return e===o.CONNECTTED&&this.config.autoReconnect&&!t}_reconnect(){this._isInReconnect=!0,c("onAutoReconnectStart"),this.config.onAutoReconnectStart(),this.connect(this.url,(e,t)=>{c("autoReconnect "+e),this._isInReconnect=!1})}_wsHandler(e,t){let i=this._state,n=this.isReconnecting;switch(e){case"onmessage":{this._data(t);break}case"onclose":case"onerror":{let r=this._needReconnect(i,n);this._disconnect();let a=e==="onclose"?13:12;this.config.onDisconnect(n?10:a,r,t),r&&this._reconnect();break}case"onopen":{this.setState(o.CONNECTTED);break}default:break}}_startTicker(){this._ticker||(this._ticker=setInterval(this._tick.bind(this),this.config.tickInterval))}_tick(){let e=Date.now(),t=this.config.protocolTimeout;if(t>0&&this._listeners.size>0)for(let r of this._listeners.values())!r.timeout&&e-r.time>t&&(r.timeout=!0,c(` - Error: 100003 : ${r.msgName} seqId: ${r.seqId}`),this.config.onProtocolTimeout&&this.config.onProtocolTimeout(r));let i=this._state,n=this.isReconnecting;switch(i){case o.CONNECTING:{e-this._connectTime>this.config.connectTimeout&&(c(" - Error: 100002"),this._disconnect(),this.config.onDisconnect(n?2:1,!1,"reconnectTimeout"));break}case o.CONNECTTED:{if(e-this._lastHeartbeatResponseTime>this.config.heartbeatTimeout){c(" - Error: 100004");let r=this._needReconnect(i,n);this._disconnect(),this.config.onDisconnect(3,r,"heartbeatTimeout"),r&&this._reconnect()}else e-this._lastHeartbeatTime>this.config.heartbeatInterval&&this._sendHeartbeat();break}}}_stopTicker(){this._ticker&&(clearInterval(this._ticker),this._ticker=null)}_sendHeartbeat(){this._lastHeartbeatTime=Date.now(),this.send(C[1],{clientTime:Date.now()},(e,t)=>{t.code===0?(this._lastHeartbeatResponseTime=Date.now(),t.serverTime?this._ping=t.serverTime-Date.now():this.config.debugMode&&c(` Heartbeat ${JSON.stringify(t)}`)):c(` - Error: 100005 heartbeatFailed: ${t}`),this.config.onHeartbeat&&this.config.onHeartbeat(t)})}};o.VERSION="1.4.7",o.NONE=0,o.DISCONNECTED=1,o.CONNECTING=2,o.CONNECTTED=3,o.protobuf=T.protobuf,o._instance=null;var E=o;T.WSocketClient=E;typeof module!="undefined"&&typeof module.exports!="undefined"&&(module.exports=E);})();
